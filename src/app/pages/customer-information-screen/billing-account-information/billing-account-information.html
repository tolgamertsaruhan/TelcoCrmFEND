<div class="p-6 md:p-8">

  <!-- LIST -->
  <div *ngIf="!isAdding && !isEditing" class="bg-white p-8 rounded-2xl shadow-xl">
    <div *ngFor="let acc of accounts" class="p-4 bg-gray-50 rounded-xl border mb-4 flex justify-between items-center">
      <div class="grid grid-cols-2 gap-4 flex-1">
        <div><span class="text-xs text-gray-500 uppercase">Type</span><p class="font-semibold">{{ acc.type }}</p></div>
        <div><span class="text-xs text-gray-500 uppercase">Status</span><p class="font-semibold">{{ acc.status }}</p></div>
        <div><span class="text-xs text-gray-500 uppercase">Account Name</span><p class="font-semibold">{{ acc.accountName }}</p></div>
        <div><span class="text-xs text-gray-500 uppercase">Account Number</span><p class="font-semibold">{{ acc.accountNumber }}</p></div>
      </div>
      <div class="flex space-x-2 ml-6">
        <button (click)="startEdit(acc)" class="text-gray-600 hover:text-orange-500">‚úèÔ∏è</button>
        <button (click)="confirmDelete(acc.id)" class="text-gray-600 hover:text-red-500">üóëÔ∏è</button>
      </div>
    </div>
    <button (click)="startAdd()" class="bg-orange-600 text-white px-5 py-2 rounded-lg shadow-md mt-6">
      + ADD NEW BILLING ACCOUNT
    </button>
  </div>

  <!-- ADD / EDIT -->
  <div *ngIf="isAdding || isEditing" class="bg-white p-8 rounded-2xl shadow-xl mt-6">
    <h2 class="text-2xl font-semibold mb-6">{{ isAdding ? 'Add New Billing Account' : 'Edit Billing Account' }}</h2>

    <form [formGroup]="accountForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="text-sm font-medium">Type</label>
        <select formControlName="type" class="form-select">
          <option *ngFor="let t of types" [value]="t">{{ t }}</option>
        </select>
      </div>

      <div>
        <label class="text-sm font-medium">Status</label>
        <select formControlName="status" class="form-select">
          <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
        </select>
      </div>

      <div>
        <label class="text-sm font-medium">Account Name</label>
        <input formControlName="accountName" type="text" class="form-input" placeholder="Enter account name" />
      </div>

      <div *ngIf="isEditing">
        <label class="text-sm font-medium">Account Number</label>
        <input formControlName="accountNumber" type="text" class="form-input bg-gray-100 cursor-not-allowed" readonly />
      </div>
    </form>

    <!-- ADDRESS SELECTION -->
    <div class="mt-8">
      <h3 class="font-semibold mb-3 text-gray-700">Select an Address</h3>

      <div *ngIf="addresses.length > 0; else noAddress" class="space-y-3">
        <div
          *ngFor="let addr of addresses"
          (click)="selectAddress(addr.id)"
          [ngClass]="{
            'border-orange-500 bg-orange-50 ring-2 ring-orange-300 scale-[1.02]': selectedAddressId === addr.id,
            'border-gray-200 hover:border-orange-300 hover:bg-orange-50/50': selectedAddressId !== addr.id
          }"
          class="cursor-pointer p-4 rounded-xl border transition-all duration-200"
        >
          <p class="font-medium text-gray-700">
            {{ addr.street }} {{ addr.houseNumber ? '#' + addr.houseNumber : '' }}
            - {{ districtNames[addr.districtId] || 'Loading...' }}, {{ cityNames[addr.districtId] || 'Loading...' }}
          </p>
        </div>
      </div>

      <ng-template #noAddress>
        <p class="text-gray-500">No addresses found. Please create one.</p>
      </ng-template>

      <div class="mt-4">
        <button (click)="startAddAddress()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md">
          + Add New Address
        </button>
      </div>
    </div>

    <!-- ‚úÖ POPUP MODAL FOR NEW ADDRESS -->
    <div
      *ngIf="showAddAddressForm"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
    >
      <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg mx-auto relative animate-fadeIn">
        <button
          (click)="showAddAddressForm = false"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl"
        >
          ‚úñ
        </button>

        <h3 class="text-xl font-semibold text-gray-800 mb-4">Add New Address</h3>

        <form [formGroup]="newAddressForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <select formControlName="cityId" (change)="onCityChangeForNewAddress()" class="form-select">
            <option [ngValue]="''" disabled>Select City</option>
            <option *ngFor="let c of cities" [ngValue]="c.id">{{ c.name }}</option>
          </select>

          <select formControlName="districtId" class="form-select">
            <option [ngValue]="''" disabled>Select District</option>
            <option *ngFor="let d of districts" [ngValue]="d.id">{{ d.name }}</option>
          </select>

          <input formControlName="street" placeholder="Street" class="form-input" />
          <input formControlName="houseNumber" placeholder="House No" class="form-input" />
          <textarea formControlName="description" rows="2" placeholder="Description" class="form-input col-span-2"></textarea>

          <label class="flex items-center space-x-2 mt-2 col-span-2">
            <input type="checkbox" formControlName="isDefault" class="h-5 w-5 text-orange-600" />
            <span>Set as Default</span>
          </label>
        </form>

        <div class="mt-6 flex justify-end space-x-3">
          <button (click)="showAddAddressForm = false" class="bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
          <button (click)="saveNewAddress()" [disabled]="!newAddressForm.valid" class="bg-green-600 text-white px-4 py-2 rounded-lg">
            Save Address
          </button>
        </div>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="mt-8 flex justify-end space-x-4">
      <button (click)="cancel()" class="bg-gray-300 px-5 py-2 rounded-lg">Cancel</button>
      <button (click)="save()" [disabled]="!accountForm.valid" class="text-white px-5 py-2 rounded-lg"
        [ngClass]="isAdding ? 'bg-green-600' : 'bg-orange-600'">
        {{ isAdding ? 'CREATE ACCOUNT' : 'UPDATE ACCOUNT' }}
      </button>
    </div>
  </div>
</div>
