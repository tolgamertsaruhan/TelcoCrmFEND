<app-navbar></app-navbar>
<app-background-item></app-background-item>

<div class="flex">
  <app-sidebar></app-sidebar>

  <!-- DIŞ CONTAINER ARTIK SCROLL YAPMIYOR -->
  <div class="flex-1 p-6 bg-[url('/assets/crm-bg.png')] bg-cover bg-center bg-fixed">

    <div class="backdrop-blur-xl bg-white/40 border border-white/30 shadow-2xl rounded-2xl p-6 max-w-5xl mx-auto">

      <h1 class="text-2xl font-bold text-gray-800 mb-6">Configuration Product</h1>

      <!-- LOADING -->
      <div *ngIf="isLoading" class="text-center py-4 text-gray-600">Loading configuration...</div>

      <!-- CONFIGURATION BLOCKS (İÇ SCROLL) -->
      <div class="max-h-[320px] overflow-y-auto pr-2 space-y-4">

        <div *ngFor="let c of configurations"
             class="bg-white/70 border border-gray-300 shadow rounded-xl p-5">

          <!-- Top Product Info -->
          <div class="grid grid-cols-2 gap-6 mb-4">
            <div>
              <p class="text-[11px] text-gray-600">Prod Offer ID</p>
              <p class="font-semibold text-gray-800">{{ c.productOfferId }}</p>
            </div>
            <div>
              <p class="text-[11px] text-gray-600">Prod Offer Name</p>
              <p class="font-semibold text-gray-800">
                {{ c.productName }}
               
              </p>
            </div>
          </div>

          <!-- 3 Columns Characteristics -->
          <div class="grid grid-cols-3 gap-6">

            <div *ngFor="let ch of c.schema" class="flex flex-col mb-2">
              <label class="text-xs font-semibold text-gray-700 mb-1">
                {{ ch.name }}
                <span *ngIf="ch.required" class="text-red-500">*</span>
              </label>

              <select
                *ngIf="ch.values?.length > 0"
                class="border rounded-lg px-2 py-1 w-full text-sm shadow-sm"
                [(ngModel)]="c.fields[ch.name]">
                <option value="">Select</option>
                <option *ngFor="let v of ch.values" [value]="v.value">{{ v.value }}</option>
              </select>

              <input
                *ngIf="ch.values?.length === 0"
                type="text"
                class="border rounded-lg px-2 py-1 w-full text-sm shadow-sm"
                [(ngModel)]="c.fields[ch.name]"
                [placeholder]="ch.description" />
            </div>

          </div>

        </div>
      </div>

      <!-- ADDRESS SELECTION (İÇ SCROLL) -->
      <div class="bg-white/70 border border-gray-300 shadow rounded-xl p-5 mt-6">

        <h2 class="text-lg font-bold text-gray-800 mb-3">Select Address</h2>

        <div class="max-h-[180px] overflow-y-auto pr-1 space-y-2">

          <div *ngFor="let a of addresses">
            <label
              class="flex items-center gap-3 bg-white p-3 rounded-xl border cursor-pointer hover:border-orange-400 transition text-sm"
              [class.border-orange-500]="selectedAddressId === a.id">

              <input
                type="radio"
                class="w-4 h-4 text-orange-600"
                name="addressRadio"
                [value]="a.id"
                [checked]="selectedAddressId === a.id"
                (change)="selectedAddressId = a.id">

              <span class="text-gray-800 leading-tight">
                <b>{{ cityNames[a.districtId] }}, {{ districtNames[a.districtId] }}</b><br>
                {{ a.street }} {{ a.houseNumber }}<br>
                <small class="text-gray-500">{{ a.description }}</small>
              </span>

            </label>
          </div>

        </div>

        <button
          (click)="showAddAddressForm = true"
          class="mt-4 px-4 py-2 bg-[#fca311] text-white rounded-lg hover:bg-[#ff8800] transition shadow text-sm">
          + ADD NEW ADDRESS
        </button>
      </div>

      <!-- SUBMIT BUTTON -->
      <div class="flex justify-end mt-6">
        <button
          (click)="onSubmit()"
          class="px-10 py-3 bg-orange-600 text-white font-bold rounded-xl shadow hover:bg-orange-700 transition">
          SUBMIT
        </button>
      </div>

    </div>
  </div>
</div>

<!-- NEW ADDRESS MODAL -->
<div *ngIf="showAddAddressForm"
     class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
     (click)="showAddAddressForm = false">

  <div class="bg-white rounded-xl p-8 w-full max-w-xl shadow-xl"
       (click)="$event.stopPropagation()">

    <h2 class="text-xl font-semibold mb-6 text-gray-800">Add New Address</h2>

    <form [formGroup]="newAddressForm" class="grid grid-cols-2 gap-4">
      <div class="col-span-2">
        <label class="font-medium text-gray-700">City</label>
        <select formControlName="cityId" (change)="onCityChange()" class="border rounded-lg w-full p-2">
          <option value="">Select City</option>
          <option *ngFor="let c of cities" [value]="c.id">{{ c.name }}</option>
        </select>
      </div>

      <div class="col-span-2">
        <label class="font-medium text-gray-700">District</label>
        <select formControlName="districtId" class="border rounded-lg w-full p-2">
          <option value="">Select District</option>
          <option *ngFor="let d of districts" [value]="d.id">{{ d.name }}</option>
        </select>
      </div>

      <div>
        <label class="font-medium">Street</label>
        <input type="text" formControlName="street" class="border rounded-lg w-full p-2">
      </div>

      <div>
        <label class="font-medium">House Number</label>
        <input type="text" formControlName="houseNumber" class="border rounded-lg w-full p-2">
      </div>

      <div class="col-span-2">
        <label>Description</label>
        <input type="text" formControlName="description" class="border rounded-lg w-full p-2">
      </div>
    </form>

    <div class="flex justify-end gap-4 mt-6">
      <button class="bg-gray-300 px-4 py-2 rounded-lg" (click)="showAddAddressForm = false">Cancel</button>

      <button
        [disabled]="!newAddressForm.valid"
        (click)="saveNewAddress()"
        class="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 disabled:opacity-50">
        Save Address
      </button>
    </div>

  </div>
</div>
